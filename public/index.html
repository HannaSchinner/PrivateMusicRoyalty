<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Private Music Royalty Distribution System</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/5.7.2/ethers.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 50%, #7e8ba3 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
            color: white;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .header p {
            font-size: 1.2em;
            opacity: 0.9;
        }

        .card {
            background: white;
            border-radius: 15px;
            padding: 30px;
            margin: 20px 0;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            backdrop-filter: blur(10px);
        }

        .connect-wallet {
            text-align: center;
            margin-bottom: 30px;
        }

        .btn {
            background: linear-gradient(45deg, #1e3c72, #2a5298);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 25px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 1px;
            box-shadow: 0 4px 15px rgba(30, 60, 114, 0.3);
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .btn-secondary {
            background: linear-gradient(45deg, #667eea, #764ba2);
        }

        .btn-success {
            background: linear-gradient(45deg, #11998e, #38ef7d);
        }

        .status {
            text-align: center;
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
            font-weight: bold;
        }

        .status.connected {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .status.error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .tabs {
            display: flex;
            margin-bottom: 30px;
            background: #f8f9fa;
            border-radius: 10px;
            padding: 5px;
        }

        .tab {
            flex: 1;
            padding: 15px;
            text-align: center;
            background: transparent;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
        }

        .tab.active {
            background: linear-gradient(45deg, #1e3c72, #2a5298);
            color: white;
            box-shadow: 0 2px 10px rgba(30, 60, 114, 0.4);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #555;
        }

        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s ease;
        }

        .form-group input:focus,
        .form-group textarea:focus,
        .form-group select:focus {
            outline: none;
            border-color: #1e3c72;
        }

        .rights-holder-form {
            display: flex;
            gap: 10px;
            align-items: end;
        }

        .rights-holder-form input {
            flex: 2;
        }

        .rights-holder-form input[type="number"] {
            flex: 1;
        }

        .rights-holder-list {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
        }

        .rights-holder-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            background: white;
            border-radius: 5px;
            margin: 5px 0;
        }

        .remove-btn {
            background: #dc3545;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 12px;
        }

        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }

        .info-card {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }

        .info-card h3 {
            color: #1e3c72;
            margin-bottom: 10px;
        }

        .info-card .value {
            font-size: 2em;
            font-weight: bold;
            color: #333;
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #1e3c72;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .hidden {
            display: none;
        }

        .track-list, .pool-list {
            margin: 20px 0;
        }

        .track-item, .pool-item {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin: 15px 0;
            border-left: 4px solid #1e3c72;
        }

        .track-item h4, .pool-item h4 {
            color: #1e3c72;
            margin-bottom: 10px;
        }

        .track-info, .pool-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 15px 0;
        }

        .track-info span, .pool-info span {
            background: white;
            padding: 8px 12px;
            border-radius: 5px;
            font-size: 14px;
        }

        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }

            .header h1 {
                font-size: 2em;
            }

            .card {
                padding: 20px;
            }

            .tabs {
                flex-direction: column;
            }

            .rights-holder-form {
                flex-direction: column;
            }

            .info-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🎵 Private Music Royalty Distribution System</h1>
            <p>Privacy-Preserving Music Revenue Distribution Platform Based on Zama FHE</p>
        </div>

        <div class="card">
            <div class="connect-wallet">
                <button id="connectWallet" class="btn">Connect Wallet</button>
                <div id="walletStatus" class="status hidden"></div>
            </div>

            <div id="mainContent" class="hidden">
                <div class="tabs">
                    <button class="tab active" onclick="showTab('register')">Register Rights Holder</button>
                    <button class="tab" onclick="showTab('track')">Register Track</button>
                    <button class="tab" onclick="showTab('pool')">Create Pool</button>
                    <button class="tab" onclick="showTab('claim')">Claim Royalty</button>
                    <button class="tab" onclick="showTab('info')">System Info</button>
                </div>

                <!-- Register Rights Holder -->
                <div id="registerTab" class="tab-content active">
                    <h3>🎯 Register as Rights Holder</h3>
                    <div class="form-group">
                        <button id="registerRightsHolder" class="btn">Register Rights Holder</button>
                    </div>
                    <div class="form-group">
                        <label>Verify Rights Holder Address:</label>
                        <input type="text" id="verifyAddress" placeholder="Enter address to verify">
                        <button id="verifyRightsHolder" class="btn btn-secondary">Verify Rights Holder</button>
                    </div>
                    <div id="rightsHolderInfo" class="info-card hidden">
                        <h4>Rights Holder Status</h4>
                        <div id="rightsHolderDetails"></div>
                    </div>
                </div>

                <!-- Register Track -->
                <div id="trackTab" class="tab-content">
                    <h3>🎼 Register Music Track</h3>
                    <div class="form-group">
                        <label>Music Metadata URI:</label>
                        <input type="text" id="metadataUri" placeholder="IPFS link or metadata URI">
                    </div>
                    <div class="form-group">
                        <label>Rights Holders List:</label>
                        <div class="rights-holder-form">
                            <input type="text" id="holderAddress" placeholder="Rights holder address">
                            <input type="number" id="holderShare" placeholder="Share (0-10000)" min="1" max="10000">
                            <button type="button" id="addHolder" class="btn btn-secondary">Add</button>
                        </div>
                        <div id="holdersList" class="rights-holder-list hidden">
                            <h4>Rights Holders List</h4>
                            <div id="holdersContainer"></div>
                            <div id="totalShares">Total Shares: 0 / 10000</div>
                        </div>
                    </div>
                    <button id="registerTrack" class="btn btn-success">Register Track</button>
                    <div id="trackList" class="track-list"></div>
                </div>

                <!-- Create Royalty Pool -->
                <div id="poolTab" class="tab-content">
                    <h3>💰 Create Royalty Pool</h3>
                    <div class="form-group">
                        <label>Select Track ID:</label>
                        <input type="number" id="poolTrackId" placeholder="Track ID" min="1">
                    </div>
                    <div class="form-group">
                        <label>Pool Amount (ETH):</label>
                        <input type="number" id="poolAmount" placeholder="0.01" step="0.001" min="0.001">
                    </div>
                    <button id="createPool" class="btn btn-success">Create Pool</button>
                    <div id="poolList" class="pool-list"></div>
                </div>

                <!-- Claim Royalty -->
                <div id="claimTab" class="tab-content">
                    <h3>🎁 Claim Royalty Revenue</h3>
                    <div class="form-group">
                        <label>Pool ID:</label>
                        <input type="number" id="claimPoolId" placeholder="Pool ID" min="1">
                    </div>
                    <button id="distributeRoyalties" class="btn btn-secondary">Distribute Royalties</button>
                    <button id="claimRoyalty" class="btn btn-success">Claim My Royalty</button>
                    <div id="claimStatus" class="info-card hidden">
                        <h4>Claim Status</h4>
                        <div id="claimDetails"></div>
                    </div>
                </div>

                <!-- System Info -->
                <div id="infoTab" class="tab-content">
                    <h3>📊 System Statistics</h3>
                    <div class="info-grid">
                        <div class="info-card">
                            <h3>Total Tracks</h3>
                            <div id="totalTracks" class="value">-</div>
                        </div>
                        <div class="info-card">
                            <h3>Total Pools</h3>
                            <div id="totalPools" class="value">-</div>
                        </div>
                        <div class="info-card">
                            <h3>Contract Address</h3>
                            <div id="contractAddress" class="value" style="font-size: 0.8em; word-break: break-all;">-</div>
                        </div>
                        <div class="info-card">
                            <h3>Current Network</h3>
                            <div id="currentNetwork" class="value">-</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // 合约配置
        const CONTRACT_ADDRESS = "0xB6082579c37D6974EcFfB87d29309eDB80f8bC90";
        const CONTRACT_ABI = [
            "function registerRightsHolder() external",
            "function verifyRightsHolder(address holder) external",
            "function registerTrack(string memory metadataURI, address[] memory holders, uint32[] memory shares) external",
            "function createRoyaltyPool(uint256 trackId) external payable",
            "function distributeRoyalties(uint256 poolId) external",
            "function claimRoyalty(uint256 poolId) external",
            "function getContractInfo() external view returns (uint256, uint256, address)",
            "function getRightsHolderInfo(address holder) external view returns (bool, uint256, uint256[])",
            "function getTrackInfo(uint256 trackId) external view returns (bool, string, uint256, address[], uint32[])",
            "function getPoolInfo(uint256 poolId) external view returns (uint256, uint256, bool, uint256, address[])",
            "function isRightsHolder(uint256 trackId, address holder) external view returns (bool)",
            "function getClaimStatus(uint256 poolId, address holder) external view returns (bool)",
            "function getPaymentAmount(uint256 poolId, address holder) external view returns (uint256)"
        ];

        let provider, signer, contract, userAccount;
        let rightsHolders = [];

        // Initialize
        window.addEventListener('load', async function() {
            if (typeof window.ethereum !== 'undefined') {
                console.log('MetaMask detected');
            } else {
                showStatus('Please install MetaMask!', 'error');
            }
        });

        // Connect Wallet
        document.getElementById('connectWallet').addEventListener('click', async function() {
            try {
                if (typeof window.ethereum === 'undefined') {
                    throw new Error('Please install MetaMask');
                }

                const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
                userAccount = accounts[0];

                provider = new ethers.providers.Web3Provider(window.ethereum);
                signer = provider.getSigner();

                if (CONTRACT_ADDRESS !== "YOUR_CONTRACT_ADDRESS_HERE") {
                    contract = new ethers.Contract(CONTRACT_ADDRESS, CONTRACT_ABI, signer);
                }

                showStatus(`Connected: ${userAccount.substring(0, 6)}...${userAccount.substring(38)}`, 'connected');
                document.getElementById('mainContent').classList.remove('hidden');
                document.getElementById('connectWallet').textContent = 'Connected';
                document.getElementById('connectWallet').disabled = true;

                await loadContractInfo();

            } catch (error) {
                console.error('Wallet connection failed:', error);
                showStatus('Connection failed: ' + error.message, 'error');
            }
        });

        // Show Status
        function showStatus(message, type) {
            const status = document.getElementById('walletStatus');
            status.textContent = message;
            status.className = `status ${type}`;
            status.classList.remove('hidden');
        }

        // Tab Switching
        function showTab(tabName) {
            // Hide all tab content
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });

            // Remove active state from all tabs
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });

            // Show selected tab content
            document.getElementById(tabName + 'Tab').classList.add('active');

            // Set selected tab as active
            event.target.classList.add('active');
        }

        // Register Rights Holder
        document.getElementById('registerRightsHolder').addEventListener('click', async function() {
            try {
                if (!contract) {
                    throw new Error('Please set contract address first');
                }

                const tx = await contract.registerRightsHolder();
                await tx.wait();

                showStatus('Rights holder registered successfully!', 'connected');
                await loadRightsHolderInfo();

            } catch (error) {
                console.error('Rights holder registration failed:', error);
                showStatus('Registration failed: ' + error.message, 'error');
            }
        });

        // Verify Rights Holder
        document.getElementById('verifyRightsHolder').addEventListener('click', async function() {
            try {
                if (!contract) {
                    throw new Error('Please set contract address first');
                }

                const address = document.getElementById('verifyAddress').value;
                if (!address) {
                    throw new Error('Please enter address');
                }

                const tx = await contract.verifyRightsHolder(address);
                await tx.wait();

                showStatus('Rights holder verified successfully!', 'connected');

            } catch (error) {
                console.error('Rights holder verification failed:', error);
                showStatus('Verification failed: ' + error.message, 'error');
            }
        });

        // Add Holder to List
        document.getElementById('addHolder').addEventListener('click', function() {
            const address = document.getElementById('holderAddress').value;
            const share = parseInt(document.getElementById('holderShare').value);

            if (!address || !share || share < 1 || share > 10000) {
                alert('Please enter valid address and share (1-10000)');
                return;
            }

            rightsHolders.push({ address, share });
            updateHoldersList();

            // Clear input fields
            document.getElementById('holderAddress').value = '';
            document.getElementById('holderShare').value = '';
        });

        // Update Holders List Display
        function updateHoldersList() {
            const container = document.getElementById('holdersContainer');
            const totalSharesElement = document.getElementById('totalShares');
            const listElement = document.getElementById('holdersList');

            if (rightsHolders.length === 0) {
                listElement.classList.add('hidden');
                return;
            }

            listElement.classList.remove('hidden');

            let totalShares = 0;
            container.innerHTML = '';

            rightsHolders.forEach((holder, index) => {
                totalShares += holder.share;

                const item = document.createElement('div');
                item.className = 'rights-holder-item';
                item.innerHTML = `
                    <span>${holder.address.substring(0, 10)}... (${holder.share})</span>
                    <button class="remove-btn" onclick="removeHolder(${index})">Remove</button>
                `;
                container.appendChild(item);
            });

            totalSharesElement.textContent = `Total Shares: ${totalShares} / 10000`;
            totalSharesElement.style.color = totalShares === 10000 ? 'green' : 'red';
        }

        // Remove Holder
        function removeHolder(index) {
            rightsHolders.splice(index, 1);
            updateHoldersList();
        }

        // Register Track
        document.getElementById('registerTrack').addEventListener('click', async function() {
            try {
                if (!contract) {
                    throw new Error('Please set contract address first');
                }

                const metadataUri = document.getElementById('metadataUri').value;
                if (!metadataUri) {
                    throw new Error('Please enter metadata URI');
                }

                if (rightsHolders.length === 0) {
                    throw new Error('Please add at least one rights holder');
                }

                const totalShares = rightsHolders.reduce((sum, holder) => sum + holder.share, 0);
                if (totalShares !== 10000) {
                    throw new Error('Total shares must equal 10000');
                }

                const addresses = rightsHolders.map(h => h.address);
                const shares = rightsHolders.map(h => h.share);

                const tx = await contract.registerTrack(metadataUri, addresses, shares);
                await tx.wait();

                showStatus('Track registered successfully!', 'connected');

                // Clear form
                document.getElementById('metadataUri').value = '';
                rightsHolders = [];
                updateHoldersList();

            } catch (error) {
                console.error('Track registration failed:', error);
                showStatus('Registration failed: ' + error.message, 'error');
            }
        });

        // Create Royalty Pool
        document.getElementById('createPool').addEventListener('click', async function() {
            try {
                if (!contract) {
                    throw new Error('Please set contract address first');
                }

                const trackId = document.getElementById('poolTrackId').value;
                const amount = document.getElementById('poolAmount').value;

                if (!trackId || !amount) {
                    throw new Error('Please enter track ID and amount');
                }

                const value = ethers.utils.parseEther(amount);
                const tx = await contract.createRoyaltyPool(trackId, { value });
                await tx.wait();

                showStatus('Royalty pool created successfully!', 'connected');

                // Clear form
                document.getElementById('poolTrackId').value = '';
                document.getElementById('poolAmount').value = '';

            } catch (error) {
                console.error('Pool creation failed:', error);
                showStatus('Creation failed: ' + error.message, 'error');
            }
        });

        // Distribute Royalties
        document.getElementById('distributeRoyalties').addEventListener('click', async function() {
            try {
                if (!contract) {
                    throw new Error('Please set contract address first');
                }

                const poolId = document.getElementById('claimPoolId').value;
                if (!poolId) {
                    throw new Error('Please enter pool ID');
                }

                const tx = await contract.distributeRoyalties(poolId);
                await tx.wait();

                showStatus('Royalties distributed successfully!', 'connected');

            } catch (error) {
                console.error('Distribution failed:', error);
                showStatus('Distribution failed: ' + error.message, 'error');
            }
        });

        // Claim Royalty
        document.getElementById('claimRoyalty').addEventListener('click', async function() {
            try {
                if (!contract) {
                    throw new Error('Please set contract address first');
                }

                const poolId = document.getElementById('claimPoolId').value;
                if (!poolId) {
                    throw new Error('Please enter pool ID');
                }

                const tx = await contract.claimRoyalty(poolId);
                await tx.wait();

                showStatus('Royalty claimed successfully!', 'connected');

            } catch (error) {
                console.error('Claim failed:', error);
                showStatus('Claim failed: ' + error.message, 'error');
            }
        });

        // Load Contract Info
        async function loadContractInfo() {
            try {
                if (!contract) return;

                const [totalTracks, totalPools, owner] = await contract.getContractInfo();

                document.getElementById('totalTracks').textContent = totalTracks.toString();
                document.getElementById('totalPools').textContent = totalPools.toString();
                document.getElementById('contractAddress').textContent = CONTRACT_ADDRESS;

                const network = await provider.getNetwork();
                document.getElementById('currentNetwork').textContent = network.name;

            } catch (error) {
                console.error('Failed to load contract info:', error);
            }
        }

        // Load Rights Holder Info
        async function loadRightsHolderInfo() {
            try {
                if (!contract || !userAccount) return;

                const [verified, registeredAt, trackIds] = await contract.getRightsHolderInfo(userAccount);

                const infoElement = document.getElementById('rightsHolderInfo');
                const detailsElement = document.getElementById('rightsHolderDetails');

                detailsElement.innerHTML = `
                    <p><strong>Verification Status:</strong> ${verified ? 'Verified' : 'Not Verified'}</p>
                    <p><strong>Registration Time:</strong> ${new Date(registeredAt * 1000).toLocaleString()}</p>
                    <p><strong>Number of Tracks:</strong> ${trackIds.length}</p>
                `;

                infoElement.classList.remove('hidden');

            } catch (error) {
                console.error('Failed to load rights holder info:', error);
            }
        }

        // Listen for Account Changes
        if (window.ethereum) {
            window.ethereum.on('accountsChanged', function(accounts) {
                if (accounts.length === 0) {
                    // User disconnected wallet
                    location.reload();
                } else {
                    // User switched account
                    location.reload();
                }
            });

            window.ethereum.on('chainChanged', function(chainId) {
                // User switched network
                location.reload();
            });
        }

        // Handle Page Load
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Private Music Royalty Distribution System loaded');

            if (CONTRACT_ADDRESS === "YOUR_CONTRACT_ADDRESS_HERE") {
                showStatus('Please set the correct contract address in the code first', 'error');
            }
        });
    </script>
</body>
</html>